# Granola - AI-Guided Test Automation Framework

[![TypeScript](https://img.shields.io/badge/TypeScript-5.9-blue.svg)](https://www.typescriptlang.org/)
[![Playwright](https://img.shields.io/badge/Playwright-1.56-green.svg)](https://playwright.dev/)
[![License](https://img.shields.io/badge/license-ISC-blue.svg)](LICENSE)

## 🎯 Overview

**Granola** is an advanced Playwright test automation framework that integrates **ContextGuard**, a sophisticated AI quality assurance system. This framework ensures that AI coding assistants (like GitHub Copilot) follow strict industry best practices, architectural patterns, and security standards when assisting with test development.

### What Makes Granola Different?

Traditional test frameworks rely on developers to manually enforce quality standards. Granola revolutionizes this approach by embedding **AI guardrails** directly into the development workflow, ensuring every line of code generated by AI assistants meets enterprise-grade quality requirements.

## ✨ Key Features

### 🎭 Playwright Test Agents
- **🎭 planner**: Explores your application and creates structured test plans in Markdown
- **🎭 generator**: Converts test plans into executable Playwright tests with live selector verification
- **🎭 healer**: Automatically repairs failing tests by replaying steps and updating locators
- **Agentic Loop**: Agents work sequentially or in loops for comprehensive test coverage
- **VS Code Insiders Integration**: Seamless integration with VS Code Insiders v1.105+ for optimal workflow

### 🤖 ContextGuard AI Quality System
- **Six Specialized Agents**: Quality, Playwright, Security, Architecture, Verification, and Integration agents
- **Intelligent Orchestration**: Automatically routes development tasks to appropriate specialized agents
- **Step-by-Step Verification**: Enforces mandatory quality checkpoints throughout development
- **Multi-Agent Workflows**: Complex tasks trigger coordinated agent handoffs for comprehensive coverage
- **Compliance Reporting**: Every task concludes with detailed audit and validation report

### 🎭 Enterprise-Grade Test Architecture
- **Page Object Model (POM)**: Enforced architectural pattern for maintainable test suites
- **TypeScript Strict Mode**: Full type safety and compile-time error detection
- **Cross-Browser Testing**: Automated testing across Chromium, Firefox, and WebKit
- **Authentication Management**: Shared authentication state with setup dependencies
- **CI/CD Ready**: Optimized configuration for continuous integration pipelines

### 🔒 Security-First Development
- **Credential Protection**: Automated detection of hardcoded secrets and credentials
- **Input Validation**: Enforced validation patterns for all user inputs
- **API Security**: Secure authentication and data handling practices
- **Security Audits**: Built-in security agent validates all authentication flows

### 📊 Advanced Test Infrastructure
- **Parallel Execution**: Fully parallelized test runs for maximum speed
- **Smart Retries**: Automatic retry logic for flaky test detection
- **Visual Testing**: Screenshot and video capture on failures
- **Trace Debugging**: Detailed trace files for comprehensive failure analysis
- **Multiple Reporters**: HTML and console reporting with CI/CD integration

## 🚀 Quick Start

### Prerequisites
- Node.js 18+ 
- npm or yarn
- Git
- **VS Code Insiders v1.105+** (required for Playwright Test Agents agentic experience)

### Installation

1. **Clone the repository**
```bash
git clone <repository-url>
cd Granola
```

2. **Install dependencies**
```bash
npm install
```

3. **Install Playwright browsers**
```bash
npx playwright install
```

4. **Initialize Playwright Test Agents**
```bash
npx playwright init-agents --loop=vscode
```
This generates agent definitions (🎭 planner, 🎭 generator, 🎭 healer) in `.github/chatmodes/`

5. **Verify installation**
```bash
npm test
```

## 📖 Usage

### Playwright Test Agents

Granola uses **Playwright Test Agents** - three specialized AI agents that work together to build and maintain tests:

- **🎭 planner** - Explores your app and produces Markdown test plans
- **🎭 generator** - Transforms test plans into executable Playwright tests
- **🎭 healer** - Automatically repairs failing tests by replaying and adjusting locators

#### Using the Agents

**Create a Test Plan:**
```
@🎭 planner Generate a plan for user login flow
```
Requires a seed test in context (e.g., `#file:tests/seed.spec.ts`)

**Generate Tests from Plan:**
```
@🎭 generator Create tests from specs/login-flow.md
```

**Heal Failing Tests:**
```
@🎭 healer Fix the failing 'user login' test
```

These agents work sequentially or in a loop to produce comprehensive test coverage.

### Running Tests

```bash
# Run all tests in headless mode
npm test

# Run tests with browser UI visible
npm run test:headed

# Interactive UI mode for test development
npm run test:ui

# Debug mode with Playwright Inspector
npm run test:debug
```

### Using ContextGuard with AI Assistants

Activate the ContextGuard orchestrator in Copilot Chat:

```
@workspace #file:ContextGuard-Orchestrator.md [your request]
```

**Example Requests:**
```
@workspace #file:ContextGuard-Orchestrator.md Create a LoginPage with Page Object Model
@workspace #file:ContextGuard-Orchestrator.md Build checkout flow with comprehensive tests
@workspace #file:ContextGuard-Orchestrator.md Audit security in authentication flows
@workspace #file:ContextGuard-Orchestrator.md Refactor tests following quality standards
```

The orchestrator automatically:
- ✅ Routes your request to the appropriate specialized agent(s)
- ✅ Enforces all ContextGuard quality standards
- ✅ Provides step-by-step progress updates
- ✅ Delivers comprehensive compliance reports

## 🏗️ Project Structure

```
Granola/
├── .github/
│   └── chatmodes/                     # Playwright Test Agent definitions
│       ├── 🎭 planner.chatmode.md     # Planning agent
│       ├── 🎭 generator.chatmode.md   # Test generation agent
│       └── 🎭 healer.chatmode.md      # Test healing agent
├── ContextGuard/                      # AI Quality Assurance System
│   ├── ContextGuard-Orchestrator.md   # Central coordination agent (START HERE)
│   ├── quality-guardrails.md          # Code quality standards
│   ├── playwright-standards.md        # Test automation best practices
│   ├── security-guidelines.md         # Security requirements
│   ├── architecture-patterns.md       # Design patterns and structure
│   ├── verification-protocol.md       # Validation checklist
│   └── agent-behavior.md              # AI agent guidelines
├── specs/                             # Human-readable test plans (generated by planner)
├── tests/                             # Test suites (generated by generator)
│   ├── auth.setup.ts                  # Authentication setup
│   ├── seed.spec.ts                   # Seed test for agent context
│   └── example.spec.ts                # Example test file
├── playwright.config.ts               # Playwright configuration
├── package.json                       # Project dependencies
└── README.md                          # This file
```

## 🎓 ContextGuard Agent System

### Specialized Agents

| Agent | Expertise | Use Case |
|-------|-----------|----------|
| **Quality Agent** | Code quality, documentation, naming | Code reviews, refactoring, documentation |
| **Playwright Agent** | POM, test design, selectors | Creating page objects, writing tests |
| **Security Agent** | Credentials, validation, protection | Authentication, API security, audits |
| **Architecture Agent** | Design patterns, structure | System design, component architecture |
| **Verification Agent** | Compliance checks, audits | Code validation, standards verification |
| **Integration Agent** | Multi-domain coordination | Complex features, end-to-end workflows |

### Agent Routing Examples

**Simple Task (Single Agent):**
```
Create ProductPage → Playwright Agent
```

**Medium Task (Two Agents):**
```
Create secure LoginPage → Playwright Agent → Security Agent
```

**Complex Task (Multi-Agent):**
```
Build checkout flow → Integration Agent coordinates:
├─ Architecture Agent (design)
├─ Playwright Agent (implementation)
├─ Security Agent (payment security)
├─ Quality Agent (documentation)
└─ Verification Agent (compliance)
```

## 🔧 Configuration

### Playwright Configuration

The framework is configured for optimal test execution:

- **Base URL**: `http://localhost:3000`
- **Test Timeout**: 30 seconds
- **Expect Timeout**: 10 seconds
- **Retries**: 2 retries in CI, 0 in local development
- **Parallelization**: Fully parallel execution
- **Browsers**: Chromium, Firefox, WebKit
- **Artifacts**: Traces, screenshots, and videos on failure

### Environment Variables

Create a `.env` file for environment-specific configuration:

```env
BASE_URL=http://localhost:3000
CI=false
```

## 📋 Best Practices Enforced

### Architectural Standards
- ✅ Page Object Model pattern for all UI interactions
- ✅ Separation of concerns (page objects, tests, fixtures)
- ✅ Reusable components and utilities
- ✅ Dependency injection for testability

### Code Quality
- ✅ TypeScript strict mode enabled
- ✅ ESLint integration with TypeScript rules
- ✅ Comprehensive JSDoc documentation
- ✅ Consistent naming conventions

### Test Design
- ✅ Test independence and isolation
- ✅ Web-first assertions with auto-waiting
- ✅ Efficient selector strategies
- ✅ Proper wait strategies (no arbitrary timeouts)
- ✅ Soft assertions for multiple validations

### Security
- ✅ No hardcoded credentials in code
- ✅ Environment variable usage for secrets
- ✅ Input validation and sanitization
- ✅ Secure authentication state management

## 🐛 Debugging

### VS Code Insiders Integration
1. **Download and install [VS Code Insiders](https://code.visualstudio.com/insiders/)** (v1.105+ required)
2. Install the [Playwright Test for VSCode](https://marketplace.visualstudio.com/items?itemName=ms-playwright.playwright) extension
3. Use Playwright Test Agents (🎭 planner, 🎭 generator, 🎭 healer) directly in chat
4. Use the Test Explorer to run and debug tests
5. Set breakpoints directly in test files

### Viewing Test Reports
```bash
# After test execution, open HTML report
npx playwright show-report
```

### Analyzing Failures
- **Traces**: Review detailed execution traces with `npx playwright show-trace trace.zip`
- **Screenshots**: Check `test-results/` for failure screenshots
- **Videos**: Watch test recordings in `test-results/` directory

## 🤝 Contributing

When contributing to this project, all code changes must pass ContextGuard validation:

1. Use the ContextGuard orchestrator for all development tasks
2. Ensure compliance with all quality guardrails
3. Include comprehensive tests for new features
4. Document code with JSDoc comments
5. Follow the verification protocol before submitting

## 📚 Additional Resources

- [Playwright Test Agents Documentation](https://playwright.dev/docs/test-agents)
- [Playwright Documentation](https://playwright.dev/)
- [VS Code Insiders Download](https://code.visualstudio.com/insiders/)
- [TypeScript Handbook](https://www.typescriptlang.org/docs/)
- [Page Object Model Pattern](https://playwright.dev/docs/pom)
- [ContextGuard Documentation](./ContextGuard/README.md)

## 📄 License

ISC License - See LICENSE file for details

## 🙋 Support

For questions or issues:
1. Review the ContextGuard documentation in `/ContextGuard`
2. Check existing test examples in `/tests`
3. Use ContextGuard orchestrator for guided assistance

---

**Built with ❤️ using Playwright, TypeScript, and AI-guided development principles**